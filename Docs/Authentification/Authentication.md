### Authentication
For authentication the application uses [JWT tokens](https://auth0.com/docs/tokens/json-web-tokens).

#### Login API
In order for a user to be authenticated a JWT token will be generated by the 
`/api/v1/login` API and will be sent to the frontend application. The response 
will look something like this:
```JSON
{
  "token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJpYXQiOjE2MjcwMjY3OTQsImV4cCI6MTYyNzAyNzk5NCwidXNlcm5hbWUiOiI5MTMyMV9kQ1NxWmVkbmhkbThYa3N6bzJaNzFuSUVXdUU3bEF0T0M0TnlnWGg0MU03QmU0cklHakV0cWNEZWpVUjA5Y0VkIiwiZm9sZGVySWQiOjk4ODI3LCJwYXJ0bmVyQ29kZSI6ImxicHBtbyJ9.ZRrQaoJ9ogalvaOGuVcHt-xgVkkXHv8uTKWo3CD2TebbveCumPD0O7QLOS3i6gVFOCUPCjvZ_MCNi5pxaFHh9QtjMJNvBJ73M_iyCTiG_o3M3KYXA15UUgSJ4lIC2Q2sZIMuOgjLSgJ9doSIt0p4LpCJT80mTEPiMFUG5s-SAg40IbDk8s-s65eJQEKrOG-wrq1EN8mgD5aCK1la9yNwE5wjqhfP5pZ6B5MXmK0Ou49H6s646m0krBHcgUw0KJ_3Up6j8WSzRT89gkxul5PB9teiLATMBIVWONnbEFP_X4eai0p_-YHonHBtpzpfm38fIP0d8t64SvXrrm3cxOY8JnLVVyCMpf3pHcKWZOYZ_U6-1iSeOgu87-66O0HI9ksypTJlbCU8E47yHB76R0vfEF1li_U75jzcn1JW9JMNd1SRaA8Xw1id1uhHd-3X4lWe7xEpofYt_CfIEqdDr2WoPoB608NFyECuuMjQsiwQRcCjcMwVsEWBq5xv2lLxxvhfsFt7UsHfAkbxMBXiRVUnayigupmeEvwoXoWsILGvf2FQSfPl3Lg0TLJO-HBkg3bCrjaMTaF7kYBBrY1qW7mf3OxDgGgdWr0dHNe4nGLW8otO40NII1xhUpJtgmEyOHPVa2Tg-Bam7iy3qVOPVEI_q_Oa2ogCv_vVvLcKRmnVy54"
}
```
Decoding the JWT will result in something similar to this
```JSON
{
  "iat": 1527026794,
  "exp": 1527027994,
  "username": "username"
}
```
This JWT will be used to keep the user authenticated on subsequent requests,
by sending it under the header `X-Auth-Token`.
```
curl -X GET "https://core-front-pro-service-dev.wks-recette.com/api/v1/user/available-agencies" \
-H  "accept: application/json" \ 
-H  "X-Auth-Token: eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJpYXQiOjE2MjcwMjY3OTQsImV4cCI6MTYyNzAyNzk5NCwidXNlcm5hbWUiOiI5MTMyMV9kQ1NxWmVkbmhkbThYa3N6bzJaNzFuSUVXdUU3bEF0T0M0TnlnWGg0MU03QmU0cklHakV0cWNEZWpVUjA5Y0VkIiwiZm9sZGVySWQiOjk4ODI3LCJwYXJ0bmVyQ29kZSI6ImxicHBtbyJ9.ZRrQaoJ9ogalvaOGuVcHt-xgVkkXHv8uTKWo3CD2TebbveCumPD0O7QLOS3i6gVFOCUPCjvZ_MCNi5pxaFHh9QtjMJNvBJ73M_iyCTiG_o3M3KYXA15UUgSJ4lIC2Q2sZIMuOgjLSgJ9doSIt0p4LpCJT80mTEPiMFUG5s-SAg40IbDk8s-s65eJQEKrOG-wrq1EN8mgD5aCK1la9yNwE5wjqhfP5pZ6B5MXmK0Ou49H6s646m0krBHcgUw0KJ_3Up6j8WSzRT89gkxul5PB9teiLATMBIVWONnbEFP_X4eai0p_-YHonHBtpzpfm38fIP0d8t64SvXrrm3cxOY8JnLVVyCMpf3pHcKWZOYZ_U6-1iSeOgu87-66O0HI9ksypTJlbCU8E47yHB76R0vfEF1li_U75jzcn1JW9JMNd1SRaA8Xw1id1uhHd-3X4lWe7xEpofYt_CfIEqdDr2WoPoB608NFyECuuMjQsiwQRcCjcMwVsEWBq5xv2lLxxvhfsFt7UsHfAkbxMBXiRVUnayigupmeEvwoXoWsILGvf2FQSfPl3Lg0TLJO-HBkg3bCrjaMTaF7kYBBrY1qW7mf3OxDgGgdWr0dHNe4nGLW8otO40NII1xhUpJtgmEyOHPVa2Tg-Bam7iy3qVOPVEI_q_Oa2ogCv_vVvLcKRmnVy54"
```

The JWT is set to expire the next day at 03:00AM and it is stored in redis with a validity of 20 minutes.
Every request that is made using that JWT will reset the validity in redis storage. The value of this is set using
an environment variable: `JWT_TTL`. Some requests alter the state of the JWT payload, like switch language 
that's why for those requests a refresh token is generated. The new refresh token is sent in the `x-extended-token` as shown below:
```
cache-control: no-cache, private  
connection: Keep-Alive  
content-length: 329  
content-type: application/json  
...
x-extended-token: eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJpYXQiOjE2MjcwMjgzOTYsImV4cCI6MTYyNzAyOTU5NiwidXNlcm5hbWUiOiI5MTMyMV9kQ1NxWmVkbmhkbThYa3N6bzJaNzFuSUVXdUU3bEF0T0M0TnlnWGg0MU03QmU0cklHakV0cWNEZWpVUjA5Y0VkIiwiZm9sZGVySWQiOjk4ODI3LCJwYXJ0bmVyQ29kZSI6ImxicHBtbyJ9.WaruvATBUsgAnq9qoGhDSOl4e_Z45ROzLXjfdUaz3Nul991rW7DNcWlskf4PrWrLqKEaro0JL6-RyI02OuG0G2tcj1mJUabTQAyXwAN71SWA5Gf0DPd9KHjDqMVBagI1-5rcKEucx-J4PfTQ7Cab3gweXfuDAXca5wJ6t94j3lGz3ulzgxoDLdc4yYrwOr3tRf0703ct3ASEe-9f2frfW1AValf1KalWe5dHX0cExX65HfiIrD-roks5AL9C0uDwxpJ49_CY8wSS26-SS42WV9SRI4EShR9cLtNHaCkxVxJ2sJGswB-yAanqmuXIENl-hait8dj_7gKj-Qx00TAWbhZceQZyC6VqDCp6SB5wz6rlH7YSm1J8ZItT1S0qJ3sYwMdy1Um_ZowxHuLbobXoUQqSKA8ElIoqGU_-eX78ipUcxDqXJBEww4ghtLftNkJkJQrIMgjf-0JTdpDCBCyjIrStmUMzIGwhvQBji8-8RNYAh_9aCoq72SF0zRt1AdUimEvkRdafTuIn076X_G2sMKCPr19SBSRBrjwaSZ1K2GgV2jLAWpOoYqdmwYO_CEbP8IR1SPyIH3KWTtYjrvqJUGEtcU-HR40_HibE1dbOYZ-_SpKXXgAEhize9inSXeXDDR1XD0rYEriuymbz6HnqlVa5vdF25-j8ppIGhjmDbwY 
...
```

### Flow
![Login flow](../assets//Login_flow.png)

The login flow starts when the user triggers the login event which calls the [Login API](#Login API).
Internally this will call the `/internalAp/login` API that will authenticate the user.
- 200: if the user and password are valid:  
    - then it will return the user entity 
- 401: if the user and password are invalid it will return 401

### Client custom authentication flow
Each client can use the default login flow or have a custom authentication flow.
- [LBP login flow](./Client%20authentication/Lbp-authentication.md)
- [LBP-PMO login flow](./Client%20authentication/Lbp-pmo-authentication.md)
- [LBP-SSO](./Client%20authentication/LBP-SSO.md)
